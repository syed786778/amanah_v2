<!-- ONLY CHANGES ARE MARKED WITH ðŸ”§ COMMENTS -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amanah - Secure Photo Sharing</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { user-select: none; background:#111827 }
        .btn-disabled { opacity:.5; pointer-events:none }
        .viewer-thumbnail { height:200px; background:#1f2937; display:flex; align-items:center; justify-content:center }
        canvas { max-width:100%; max-height:100% }
        .screenshot-block-overlay{position:fixed;inset:0;background:#000;z-index:9999;display:none;align-items:center;justify-content:center;color:#fff}
        .screenshot-block-overlay.active{display:flex}
    </style>
</head>

<body>
<div id="screenshot-block-overlay" class="screenshot-block-overlay">
    <h2 class="text-2xl font-bold">âš  Screenshot Detected</h2>
</div>

<div id="app"></div>

<script>
/* ---------------- CONFIG ---------------- */
const supabase = window.supabase.createClient(
    'https://imiljivxosyrcosznklh.supabase.co',
    'YOUR_ANON_KEY'
);

/* ---------------- STATE ---------------- */
let state = {
    view: 'home',
    accessMode: null,          // ðŸ”§ 'owner' | 'viewer'
    currentAlbum: null,
    uploaderInfo: { name:'', email:'' },
    photos: [],
    otp: '',
    otpExpiry: null,
    shareLink: '',
    viewerOtp: '',
    albumIdToView: '',
    loading: false,
    lightboxIndex: null,
    screenshotAttempts: 0
};

/* ---------------- HELPERS ---------------- */
const genOTP = () => Math.floor(100000+Math.random()*900000).toString();
const genAlbumId = () => 'album_' + Math.random().toString(36).slice(2,9);
const formatTime = t => {
    const d = t - Date.now();
    if (d <= 0) return 'Expired';
    const m = Math.floor(d / 60000);
    return m < 60 ? `${m}m` : `${Math.floor(m/60)}h`;
};

/* ---------------- NAV ---------------- */
function nav(v){
    state.view = v;
    state.lightboxIndex = null;
    render();
}

/* ---------------- UPLOAD ---------------- */
async function upload(){
    if(!state.uploaderInfo.name || !state.uploaderInfo.email || !state.photos.length){
        alert('Missing fields'); return;
    }
    state.loading=true; render();

    const id = genAlbumId();
    const otp = genOTP();
    const expiry = Date.now() + 86400000;

    await supabase.from('albums').insert({
        id, name: state.uploaderInfo.name,
        email: state.uploaderInfo.email.toLowerCase(),
        otp, otp_expiry: expiry
    });

    await supabase.from('photos').insert(
        state.photos.map(p => ({ album_id:id, photo_data:p }))
    );

    state.currentAlbum = { id, name: state.uploaderInfo.name, photos: state.photos };
    state.otp = otp;
    state.otpExpiry = expiry;
    state.shareLink = location.origin + '?album=' + id;

    state.accessMode = 'owner';       // ðŸ”§ explicit
    state.view = 'gallery';
    state.loading=false;
    render();
}

/* ---------------- MANAGE ---------------- */
async function manageAlbum(){
    state.loading=true; render();

    const { data:album } = await supabase
        .from('albums').select('*')
        .eq('email', state.uploaderInfo.email.toLowerCase())
        .single();

    const { data:photos } = await supabase
        .from('photos').select('*')
        .eq('album_id', album.id)
        .order('created_at');

    state.currentAlbum = { ...album, photos: photos.map(p=>p.photo_data) };
    state.otp = album.otp;
    state.otpExpiry = album.otp_expiry;
    state.shareLink = location.origin + '?album=' + album.id;

    state.accessMode = 'owner';       // ðŸ”§ explicit
    state.view = 'gallery';
    state.loading=false;
    render();
}

/* ---------------- VERIFY (VIEWER) ---------------- */
async function verify(){
    state.loading=true; render();

    const { data:album } = await supabase
        .from('albums').select('*')
        .eq('id', state.albumIdToView)
        .single();

    if(Date.now() > album.otp_expiry || album.otp !== state.viewerOtp){
        alert('Invalid or expired OTP');
        state.loading=false; render(); return;
    }

    const { data:photos } = await supabase
        .from('photos').select('*')
        .eq('album_id', album.id)
        .order('created_at');

    state.currentAlbum = { ...album, photos: photos.map(p=>p.photo_data) };

    state.accessMode = 'viewer';      // ðŸ”§ explicit
    state.view = 'gallery';
    state.loading=false;
    render();
}

/* ---------------- PROTECTION ---------------- */
function setupProtection(){
    if(state.accessMode !== 'viewer') return;   // ðŸ”§ owner never blocked
    document.addEventListener('contextmenu', e => {
        e.preventDefault();
        handleScreenshot();
    });
}
function handleScreenshot(){
    state.screenshotAttempts++;
    if(state.screenshotAttempts >= 2){
        document.getElementById('screenshot-block-overlay').classList.add('active');
        setTimeout(()=>nav('home'),1000);
    }
}

/* ---------------- RENDER ---------------- */
function render(){
    document.getElementById('app').innerHTML = `
        ${state.loading ? '<p class="p-8 text-center">Loadingâ€¦</p>' : ''}
        ${state.view === 'home' ? `
            <div class="p-12 text-center">
                <h1 class="text-4xl font-bold text-purple-400">Amanah</h1>
                <button onclick="nav('upload')" class="mt-6 bg-purple-600 px-6 py-3 rounded">Create Album</button>
                <button onclick="nav('viewer')" class="ml-4 bg-gray-700 px-6 py-3 rounded">View Album</button>
            </div>
        ` : ''}

        ${state.view === 'gallery' && state.currentAlbum ? `
            <div class="p-8">
                <h2 class="text-2xl mb-4">${state.currentAlbum.name}'s Album</h2>

                ${state.accessMode === 'owner' ? `
                    <div class="mb-6 p-4 bg-gray-800 rounded">
                        <p>OTP: <strong>${state.otp}</strong></p>
                        <p>Expires in: ${formatTime(state.otpExpiry)}</p>
                        <p class="text-sm break-all">${state.shareLink}</p>
                    </div>
                ` : ''}

                <div class="grid grid-cols-2 gap-4">
                    ${state.currentAlbum.photos.map((_,i)=>`
                        <div class="viewer-thumbnail">
                            <canvas id="secure-photo-${i}"></canvas>
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}
    `;

    if(state.view === 'gallery'){
        setTimeout(()=>{
            setupProtection();
            state.currentAlbum.photos.forEach((p,i)=>{
                const c=document.getElementById(`secure-photo-${i}`);
                const ctx=c.getContext('2d');
                const img=new Image();
                img.onload=()=>{c.width=img.width;c.height=img.height;ctx.drawImage(img,0,0)};
                img.src=p;
            });
        },50);
    }
}

render();
</script>
</body>
</html>
