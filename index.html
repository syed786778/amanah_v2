<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <meta name="description" content="Amanah - Secure marriage profile photo sharing with OTP protection by Syed Rashad">
Â  Â  <title>Amanah - Secure Photo Sharing</title>
Â  Â  
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
Â  Â  
Â  Â  <style>
Â  Â  Â  Â  /* Base styles */
Â  Â  Â  Â  .card-shadow {
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-gradient-purple {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #a855f7, #9333ea);
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-gradient-purple:hover {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #9333ea, #7e22ce);
Â  Â  Â  Â  Â  Â  transform: translateY(-1px);
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  /* Ensures canvas container maintains aspect ratio without stretching the canvas CSS size */
Â  Â  Â  Â  .secure-image-container {
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  -webkit-user-select: none;
Â  Â  Â  Â  Â  Â  user-select: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  .viewer-thumbnail {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 200px; /* Fixed height for thumbnails */
Â  Â  Â  Â  Â  Â  background-color: #1f2937;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .viewer-thumbnail canvas {
Â  Â  Â  Â  Â  Â  max-width: 100%;
Â  Â  Â  Â  Â  Â  max-height: 100%;
Â  Â  Â  Â  Â  Â  object-fit: contain; 
Â  Â  Â  Â  Â  Â  width: auto !important; /* Override inline style width */
Â  Â  Â  Â  Â  Â  height: auto !important; /* Override inline style height */
Â  Â  Â  Â  }

Â  Â  Â  Â  .btn-disabled {
Â  Â  Â  Â  Â  Â  background-color: #6b7280;
Â  Â  Â  Â  Â  Â  cursor: not-allowed;
Â  Â  Â  Â  Â  Â  opacity: 0.6;
Â  Â  Â  Â  Â  Â  pointer-events: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  .screenshot-block-overlay {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  background-color: #000;
Â  Â  Â  Â  Â  Â  z-index: 9999;
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .screenshot-block-overlay.active {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  }

Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  /* Prevent selecting/copying text/images */
Â  Â  Â  Â  Â  Â  -webkit-user-select: none; 
Â  Â  Â  Â  Â  Â  -moz-user-select: none; 
Â  Â  Â  Â  Â  Â  -ms-user-select: none; 
Â  Â  Â  Â  Â  Â  user-select: none;
Â  Â  Â  Â  Â  Â  overflow-x: hidden; /* Prevent horizontal scroll on mobile */
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  /* * IMPROVED STYLES FOR UNCONTROLLED SHARING CHAIN 
Â  Â  Â  Â  */
Â  Â  Â  Â  .story-step {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  }
Â  Â  Â  Â  .story-icon {
Â  Â  Â  Â  Â  Â  background-color: #9333ea;
Â  Â  Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  Â  Â  padding: 1rem;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  display: inline-flex;
Â  Â  Â  Â  Â  Â  margin-bottom: 0.75rem;
Â  Â  Â  Â  Â  Â  z-index: 10;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 0 5px #1f2937; /* Dark background ring */
Â  Â  Â  Â  }
Â  Â  Â  Â  .story-connector {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 2.5rem;
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  height: 3px;
Â  Â  Â  Â  Â  Â  background-color: #374151; /* Darker connector */
Â  Â  Â  Â  Â  Â  z-index: 5;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Adjusted positioning for connectors to fill gap between icons */
Â  Â  Â  Â  .story-step:not(:last-child) .story-connector {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  transform: translateX(50%);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Highlight the problematic steps */
Â  Â  Â  Â  .story-step-problem .story-icon {
Â  Â  Â  Â  Â  Â  background-color: #dc2626; /* Red for problem */
Â  Â  Â  Â  }
Â  Â  Â  Â  .story-step-risk .story-icon {
Â  Â  Â  Â  Â  Â  background-color: #f59e0b; /* Yellow/Orange for risk */
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  /* Mobile adjustment for connectors */
Â  Â  Â  Â  @media (max-width: 768px) {
Â  Â  Â  Â  Â  Â  .story-connector {
Â  Â  Â  Â  Â  Â  Â  Â  display: none; /* Hide horizontal connectors on small screens */
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </style>
Â  Â  
Â  Â  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YPHFTQYLE1"></script>
Â  Â  <script>
Â  Â  Â  Â  window.dataLayer = window.dataLayer || [];
Â  Â  Â  Â  function gtag(){dataLayer.push(arguments);}
Â  Â  Â  Â  gtag('js', new Date());
Â  Â  Â  Â  gtag('config', 'G-YPHFTQYLE1');
Â  Â  </script>
</head>
<body class="bg-gray-900 text-gray-200" oncopy="return false;" oncut="return false;">
Â  Â  
Â  Â  <div id="screenshot-block-overlay" class="screenshot-block-overlay">
Â  Â  Â  Â  <svg class="w-24 h-24 text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
Â  Â  Â  Â  Â  Â  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
Â  Â  Â  Â  </svg>
Â  Â  Â  Â  <h2 class="text-2xl font-bold text-white mb-2">âš ï¸ Screenshot Detected</h2>
Â  Â  Â  Â  <p class="text-gray-300 text-center px-4">Screenshots are prohibited. You will be logged out shortly.</p>
Â  Â  </div>

Â  Â  <div id="app"></div>
Â  Â  
Â  Â  <script>
Â  Â  Â  Â  const SUPABASE_URL = 'https://imiljivxosyrcosznklh.supabase.co';
Â  Â  Â  Â  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltaWxqaXZ4b3N5cmNvc3pua2xoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMTIwOTcsImV4cCI6MjA3OTY4ODA5N30.TOgeuC3-RdG2ywIxDz2NWRhLHI4gxTkG4pilaZBqhso';
Â  Â  Â  Â  
Â  Â  Â  Â  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
Â  Â  Â  Â  
Â  Â  Â  Â  let visibilityChangeCount = 0;
Â  Â  Â  Â  let lastVisibilityChange = 0;
Â  Â  Â  Â  let protectionActive = false;

Â  Â  Â  Â  let state = {
Â  Â  Â  Â  Â  Â  view: 'home',
Â  Â  Â  Â  Â  Â  currentAlbum: null,
Â  Â  Â  Â  Â  Â  uploaderInfo: { name: '', email: '' },
Â  Â  Â  Â  Â  Â  photos: [],
Â  Â  Â  Â  Â  Â  shareLink: '',
Â  Â  Â  Â  Â  Â  otp: '',
Â  Â  Â  Â  Â  Â  otpExpiry: null,
Â  Â  Â  Â  Â  Â  viewerOtp: '',
Â  Â  Â  Â  Â  Â  albumIdToView: '',
Â  Â  Â  Â  Â  Â  isVerified: false,
Â  Â  Â  Â  Â  Â  loading: false,
Â  Â  Â  Â  Â  Â  lightboxIndex: null,
Â  Â  Â  Â  Â  Â  manageEmail: '',
Â  Â  Â  Â  Â  Â  termsAccepted: false,
Â  Â  Â  Â  Â  Â  screenshotAttempts: 0 
Â  Â  Â  Â  };
Â  Â  Â  Â  
Â  Â  Â  Â  function genOTP(){return Math.floor(100000+Math.random()*900000).toString()}
Â  Â  Â  Â  function genAlbumId(){return'album_'+Math.random().toString(36).substr(2,9)}
Â  Â  Â  Â  
Â  Â  Â  Â  // FIX: Corrected formatTime to handle milliseconds correctly and show H/M/M.
Â  Â  Â  Â  function formatTime(e){
Â  Â  Â  Â  Â  Â  const r=e-Date.now();
Â  Â  Â  Â  Â  Â  if(r<=0)return 'Expired';
Â  Â  Â  Â  Â  Â  const t=Math.floor(r/36e5); // Hours
Â  Â  Â  Â  Â  Â  const n=Math.floor(r%36e5/6e4); // Minutes
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Show only minutes if less than 1 hour, otherwise show H/M
Â  Â  Â  Â  Â  Â  if (t > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  return `${t}h ${n}m`;
Â  Â  Â  Â  Â  Â  } else if (n > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  return `${n}m`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // If less than a minute, show 'less than 1m'
Â  Â  Â  Â  Â  Â  Â  Â  return 'less than 1m';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function actionCard(title, color, svgPath, text, buttonText, action) {
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-700 hover:border-${color}-500 transition-all duration-300 flex flex-col">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-start mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-8 h-8 text-${color}-400 mr-3 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">${svgPath}</svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-white leading-tight">${title}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-gray-400 space-y-2 mb-8 text-sm flex-grow">${text}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="${action}" class="w-full bg-${color}-600 text-white py-3 rounded-lg font-semibold transition-all duration-300 hover:bg-${color}-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${buttonText}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  function nav(e){
Â  Â  Â  Â  Â  Â  protectionActive=false;
Â  Â  Â  Â  Â  Â  state.view=e;
Â  Â  Â  Â  Â  Â  if(e==='home'||e==='upload'||e==='manage'||e==='viewer'){
Â  Â  Â  Â  Â  Â  Â  Â  // Preserve album data if navigating to another management view, but clear it for home/upload/viewer input
Â  Â  Â  Â  Â  Â  Â  Â  if(e === 'home' || e === 'upload' || e === 'viewer') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.photos=[];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.uploaderInfo={name:'',email:''};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.currentAlbum=null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  state.isVerified=false;
Â  Â  Â  Â  Â  Â  Â  Â  state.viewerOtp='';
Â  Â  Â  Â  Â  Â  Â  Â  state.albumIdToView='';
Â  Â  Â  Â  Â  Â  Â  Â  state.lightboxIndex=null;
Â  Â  Â  Â  Â  Â  Â  Â  state.screenshotAttempts=0;
Â  Â  Â  Â  Â  Â  Â  Â  window.history.pushState({},document.title,location.pathname)
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  render()
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function toggleTerms(checkbox) {
Â  Â  Â  Â  Â  Â  state.termsAccepted = checkbox.checked;
Â  Â  Â  Â  Â  Â  checkUploadFormComplete(); 
Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  let uploadFormComplete = false;
Â  Â  Â  Â  
Â  Â  Â  Â  function checkUploadFormComplete() {
Â  Â  Â  Â  Â  Â  const isComplete = !!state.uploaderInfo.name && !!state.uploaderInfo.email && state.photos.length > 0 && state.termsAccepted;
Â  Â  Â  Â  Â  Â  if (isComplete !== uploadFormComplete) {
Â  Â  Â  Â  Â  Â  Â  Â  uploadFormComplete = isComplete;
Â  Â  Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function updateUploaderName(input) {
Â  Â  Â  Â  Â  Â  state.uploaderInfo.name = input.value;
Â  Â  Â  Â  Â  Â  checkUploadFormComplete();
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateUploaderEmail(input) {
Â  Â  Â  Â  Â  Â  state.uploaderInfo.email = input.value;
Â  Â  Â  Â  Â  Â  checkUploadFormComplete();
Â  Â  Â  Â  }

Â  Â  Â  Â  let verifyFormComplete = false;
Â  Â  Â  Â  
Â  Â  Â  Â  function checkVerifyFormComplete() {
Â  Â  Â  Â  Â  Â  const isComplete = !!state.albumIdToView && !!state.viewerOtp && state.viewerOtp.length === 6;
Â  Â  Â  Â  Â  Â  if (isComplete !== verifyFormComplete) {
Â  Â  Â  Â  Â  Â  Â  Â  verifyFormComplete = isComplete;
Â  Â  Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateAlbumId(input) {
Â  Â  Â  Â  Â  Â  // Cleanup input to only keep the ID if a full URL was pasted
Â  Â  Â  Â  Â  Â  const value = input.value.trim();
Â  Â  Â  Â  Â  Â  const urlMatch = value.match(/album=(album_[a-z0-9]+)/);
Â  Â  Â  Â  Â  Â  state.albumIdToView = urlMatch ? urlMatch[1] : value;
Â  Â  Â  Â  Â  Â  checkVerifyFormComplete();
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateViewerOtp(input) {
Â  Â  Â  Â  Â  Â  state.viewerOtp = input.value;
Â  Â  Â  Â  Â  Â  checkVerifyFormComplete();
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  let manageFormComplete = false;
Â  Â  Â  Â  
Â  Â  Â  Â  function checkManageFormComplete() {
Â  Â  Â  Â  Â  Â  // Basic email validation check for form completion
Â  Â  Â  Â  Â  Â  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
Â  Â  Â  Â  Â  Â  const isComplete = emailRegex.test(state.manageEmail);
Â  Â  Â  Â  Â  Â  if (isComplete !== manageFormComplete) {
Â  Â  Â  Â  Â  Â  Â  Â  manageFormComplete = isComplete;
Â  Â  Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateManageEmail(input) {
Â  Â  Â  Â  Â  Â  state.manageEmail = input.value;
Â  Â  Â  Â  Â  Â  checkManageFormComplete();
Â  Â  Â  Â  }

Â  Â  Â  Â  function scrambleCanvasPixels(canvasId) {
Â  Â  Â  Â  Â  Â  const canvas = document.getElementById(canvasId);
Â  Â  Â  Â  Â  Â  if (!canvas) return;

Â  Â  Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Set canvas size based on its current rendered size for fast scramble
Â  Â  Â  Â  Â  Â  const width = canvas.offsetWidth || 600; 
Â  Â  Â  Â  Â  Â  const height = canvas.offsetHeight || 400;

Â  Â  Â  Â  Â  Â  canvas.width = width;
Â  Â  Â  Â  Â  Â  canvas.height = height;

Â  Â  Â  Â  Â  Â  // Simple scramble effect
Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#1f2937'; 
Â  Â  Â  Â  Â  Â  ctx.fillRect(0, 0, width, height);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  ctx.save();
Â  Â  Â  Â  Â  Â  ctx.fillStyle = 'rgba(255, 0, 0, 0.9)';
Â  Â  Â  Â  Â  Â  ctx.font = 'bold 50px Arial'; 
Â  Â  Â  Â  Â  Â  ctx.textAlign = 'center';
Â  Â  Â  Â  Â  Â  ctx.textBaseline = 'middle';
Â  Â  Â  Â  Â  Â  ctx.fillText('ACCESS DENIED', width / 2, height / 2);
Â  Â  Â  Â  Â  Â  ctx.restore();

Â  Â  Â  Â  Â  Â  console.log(`âš¡ Canvas ${canvasId} Scrambled!`);
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleScreenshotAttempt() {
Â  Â  Â  Â  Â  Â  state.screenshotAttempts++;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Scramble all visible secure canvases (thumbnails and lightbox)
Â  Â  Â  Â  Â  Â  const canvasElements = document.querySelectorAll('canvas[id^="secure-photo-"]');
Â  Â  Â  Â  Â  Â  canvasElements.forEach(canvas => scrambleCanvasPixels(canvas.id));
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const overlay = document.getElementById('screenshot-block-overlay');
Â  Â  Â  Â  Â  Â  if (overlay) {
Â  Â  Â  Â  Â  Â  Â  Â  overlay.classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  console.warn('Screenshot attempt detected:', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  album: state.currentAlbum?.id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  attemptNumber: state.screenshotAttempts
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // Log the incident (simulated here)

Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nav('home');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('You have been logged out due to unauthorized screen capture attempt. This incident has been logged.');
Â  Â  Â  Â  Â  Â  Â  Â  }, 1000); 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function showScreenshotWarning() {
Â  Â  Â  Â  Â  Â  alert('âš ï¸ Screenshots and screen recording are strictly prohibited!\n\nThis action has been logged and may result in restricted access.');
Â  Â  Â  Â  Â  Â  state.screenshotAttempts++;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (state.screenshotAttempts >= 2) { 
Â  Â  Â  Â  Â  Â  Â  Â  handleScreenshotAttempt();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function setupProtection() {
Â  Â  Â  Â  Â  Â  if (protectionActive) return;
Â  Â  Â  Â  Â  Â  protectionActive = true;

Â  Â  Â  Â  Â  Â  const viewerContent = document.getElementById('viewer-content-area') || document.getElementById('lightbox-container');
Â  Â  Â  Â  Â  Â  const overlay = document.getElementById('screenshot-block-overlay');
Â  Â  Â  Â  Â  Â  if (!viewerContent || !overlay) return;

Â  Â  Â  Â  Â  Â  console.log('ğŸ”’ Enhanced protection activated');

Â  Â  Â  Â  Â  Â  const contextMenuBlocker = e => { 
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault(); 
Â  Â  Â  Â  Â  Â  Â  Â  showScreenshotWarning();
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const keyBlocker = e => {
Â  Â  Â  Â  Â  Â  Â  Â  // F12, PrintScreen, Mac screenshot combos, Ctrl+Shift+I/J (Dev Tools), Ctrl+P (Print)
Â  Â  Â  Â  Â  Â  Â  Â  if (e.keyCode === 123 || e.key === 'PrintScreen' || 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (e.metaKey && e.shiftKey && (e.key === '3' || e.key === '4' || e.key === '5')) ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (e.ctrlKey && e.key === 'p')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleScreenshotAttempt(); 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  document.addEventListener('contextmenu', contextMenuBlocker);
Â  Â  Â  Â  Â  Â  document.addEventListener('keydown', keyBlocker);

Â  Â  Â  Â  Â  Â  const handleVisibilityChange = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const now = Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  const timeSinceLastChange = now - lastVisibilityChange;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Rapid tab switching or window minimization/restoration 
Â  Â  Â  Â  Â  Â  Â  Â  if (document.visibilityState === 'hidden') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (timeSinceLastChange < 1500 && timeSinceLastChange > 50) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  visibilityChangeCount++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (visibilityChangeCount >= 2) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleScreenshotAttempt();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  visibilityChangeCount = 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastVisibilityChange = now;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (document.visibilityState === 'visible') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Reset count after a delay
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => { visibilityChangeCount = 0; }, 3000); 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  document.addEventListener('visibilitychange', handleVisibilityChange);

Â  Â  Â  Â  Â  Â  let blurStartTime = 0;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Focus/Blur event for fast window switching (common in screenshot tools)
Â  Â  Â  Â  Â  Â  window.addEventListener('blur', () => {
Â  Â  Â  Â  Â  Â  Â  Â  blurStartTime = Date.now();
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  window.addEventListener('focus', () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (blurStartTime > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const blurDuration = Date.now() - blurStartTime;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (blurDuration < 500 && blurDuration > 50) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleScreenshotAttempt(); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  blurStartTime = 0;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // IMPROVED: Watermark positioning, rotation, and opacity
Â  Â  Â  Â  function drawPhotoOnCanvas(canvasId, photoData, watermarkText, isLightbox = false) {
Â  Â  Â  Â  Â  Â  const canvas = document.getElementById(canvasId);
Â  Â  Â  Â  Â  Â  if (!canvas) return;

Â  Â  Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  Â  Â  const img = new Image();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  img.onload = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const imgWidth = img.width;
Â  Â  Â  Â  Â  Â  Â  Â  const imgHeight = img.height; 
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Set native dimensions for drawing
Â  Â  Â  Â  Â  Â  Â  Â  canvas.width = imgWidth;
Â  Â  Â  Â  Â  Â  Â  Â  canvas.height = imgHeight;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Set CSS dimensions for display control
Â  Â  Â  Â  Â  Â  Â  Â  if(isLightbox) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  canvas.style.maxWidth = '100%';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  canvas.style.maxHeight = '90vh';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  canvas.style.width = 'auto';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  canvas.style.height = 'auto';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Thumbnail dimensions
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  canvas.style.width = '100%';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  canvas.style.height = '100%'; 
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  ctx.drawImage(img, 0, 0, imgWidth, imgHeight);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // --- Watermark Logic ---
Â  Â  Â  Â  Â  Â  Â  Â  ctx.save();
Â  Â  Â  Â  Â  Â  Â  Â  ctx.globalAlpha = 0.08; // Reduced opacity for less intrusion
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = 'white';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Scale watermark text size based on image size
Â  Â  Â  Â  Â  Â  Â  Â  const watermarkSize = Math.max(100, imgWidth / 10); 
Â  Â  Â  Â  Â  Â  Â  Â  ctx.font = `bold ${watermarkSize}px Arial`; 
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  ctx.textAlign = 'center';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.textBaseline = 'middle';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const centerX = imgWidth / 2;
Â  Â  Â  Â  Â  Â  Â  Â  const centerY = imgHeight / 2;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Rotate by -45 degrees
Â  Â  Â  Â  Â  Â  Â  Â  ctx.translate(centerX, centerY);
Â  Â  Â  Â  Â  Â  Â  Â  ctx.rotate(-45 * Math.PI / 180);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillText(watermarkText || 'Amanah Secured', 0, 0);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  ctx.restore();
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  img.onerror = () => {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Failed to load photo data for canvas ${canvasId}`);
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#333';
Â  Â  Â  Â  Â  Â  Â  Â  canvas.style.width = '100%';
Â  Â  Â  Â  Â  Â  Â  Â  canvas.style.height = '300px'; 
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillRect(0, 0, canvas.width, canvas.height);
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = 'red';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.font = 'bold 50px Arial';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.textAlign = 'center';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillText('Image Load Error', canvas.width / 2, canvas.height / 2);
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  img.src = photoData;
Â  Â  Â  Â  }

Â  Â  Â  Â  function createShareMessage() {
Â  Â  Â  Â  Â  Â  const albumName = state.currentAlbum ? state.currentAlbum.name : 'Secured Photos';
Â  Â  Â  Â  Â  Â  const link = state.shareLink;
Â  Â  Â  Â  Â  Â  const otp = state.otp;
Â  Â  Â  Â  Â  Â  return `*--- Amanah Secure Photo Share ---*\nHello, here is the link to view the photo album for *${albumName}*.\n\nğŸ”’ *Album Access Details:*\n- *Share Link:* ${link}\n- *One-Time Passcode (OTP):* ${otp}\n\n*Instructions:* Tap the link, then enter the OTP to view the secured photos. The access is valid for ${formatTime(state.otpExpiry)} from now.\n\nRegards,\n${state.currentAlbum.name}`.trim();
Â  Â  Â  Â  }

Â  Â  Â  Â  function copyText() {
Â  Â  Â  Â  Â  Â  navigator.clipboard.writeText(createShareMessage());
Â  Â  Â  Â  Â  Â  alert('Shareable link & OTP copied to clipboard!');
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function copyOtp() {
Â  Â  Â  Â  Â  Â  navigator.clipboard.writeText(state.otp);
Â  Â  Â  Â  Â  Â  alert('OTP copied to clipboard!');
Â  Â  Â  Â  }

Â  Â  Â  Â  function copyLink() {
Â  Â  Â  Â  Â  Â  navigator.clipboard.writeText(state.shareLink);
Â  Â  Â  Â  Â  Â  alert('Shareable link copied to clipboard!');
Â  Â  Â  Â  }

Â  Â  Â  Â  function shareViaWhatsApp() {
Â  Â  Â  Â  Â  Â  const message = createShareMessage();
Â  Â  Â  Â  Â  Â  const encodedMessage = encodeURIComponent(message);
Â  Â  Â  Â  Â  Â  window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
Â  Â  Â  Â  }

Â  Â  Â  Â  function openLightbox(index){state.lightboxIndex=index;render();setTimeout(setupProtection,100);}
Â  Â  Â  Â  function closeLightbox(){state.lightboxIndex=null;render();}
Â  Â  Â  Â  function nextPhoto(){if(state.lightboxIndex<state.currentAlbum.photos.length-1){state.lightboxIndex++;render();setTimeout(setupProtection,100);}}
Â  Â  Â  Â  function prevPhoto(){if(state.lightboxIndex>0){state.lightboxIndex--;render();setTimeout(setupProtection,100);}}
Â  Â  Â  Â  
Â  Â  Â  Â  function handleFiles(e){
Â  Â  Â  Â  Â  Â  const maxPhotos = 4; // Use constant here for file selection limit
Â  Â  Â  Â  Â  Â  const t=Array.from(e.target.files);
Â  Â  Â  Â  Â  Â  Promise.all(t.map(e=>new Promise(t=>{
Â  Â  Â  Â  Â  Â  Â  Â  const n=new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â  n.onload=e=>t(e.target.result);
Â  Â  Â  Â  Â  Â  Â  Â  n.readAsDataURL(e)
Â  Â  Â  Â  Â  Â  }))).then(e=>{
Â  Â  Â  Â  Â  Â  Â  Â  state.photos=[...state.photos,...e].slice(0, maxPhotos);
Â  Â  Â  Â  Â  Â  Â  Â  checkUploadFormComplete();
Â  Â  Â  Â  Â  Â  Â  Â  render()
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  async function manageAlbum(){ 
Â  Â  Â  Â  Â  Â  if(!manageFormComplete){alert('Please enter a valid email address.');return}
Â  Â  Â  Â  Â  Â  state.loading=true;render();
Â  Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  Â  Â  const{data:albums,error}=await supabase.from('albums').select('*').eq('email',state.manageEmail.trim().toLowerCase()).limit(1);
Â  Â  Â  Â  Â  Â  Â  Â  if(error)throw error;
Â  Â  Â  Â  Â  Â  Â  Â  if(!albums||albums.length===0){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('No albums found with this email address.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.loading=false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const album=albums[0];
Â  Â  Â  Â  Â  Â  Â  Â  const{data:photos}=await supabase.from('photos').select('*').eq('album_id',album.id).order('created_at',{ascending:true});
Â  Â  Â  Â  Â  Â  Â  Â  state.currentAlbum={...album,photos:photos.map(p=>p.photo_data)};
Â  Â  Â  Â  Â  Â  Â  Â  state.otp=album.otp;
Â  Â  Â  Â  Â  Â  Â  Â  state.otpExpiry=album.otp_expiry;
Â  Â  Â  Â  Â  Â  Â  Â  state.shareLink=location.origin+location.pathname+'?album='+album.id;
Â  Â  Â  Â  Â  Â  Â  Â  state.view='gallery';
Â  Â  Â  Â  Â  Â  Â  Â  state.loading=false;
Â  Â  Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  }catch(e){
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Manage error:',e);
Â  Â  Â  Â  Â  Â  Â  Â  alert('Failed to load albums: '+e.message);
Â  Â  Â  Â  Â  Â  Â  Â  state.loading=false;
Â  Â  Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  async function upload(){
Â  Â  Â  Â  Â  Â  if (!state.termsAccepted) {
Â  Â  Â  Â  Â  Â  Â  Â  alert('You must accept the Terms & Conditions before creating an album.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if(!state.uploaderInfo.name||!state.uploaderInfo.email||!state.photos.length){alert('Please fill all required fields and upload at least one photo');return}state.loading=true;render();try{const e=genAlbumId(),t=genOTP(),n=Date.now()+864e5,{data:a,error:o}=await supabase.from('albums').insert({id:e,name:state.uploaderInfo.name,email:state.uploaderInfo.email.trim().toLowerCase(),otp:t,otp_expiry:n,created_at:Date.now()}).select().single();if(o)throw o;const{error:r}=await supabase.from('photos').insert(state.photos.map(t=>({album_id:e,photo_data:t})));if(r)throw r;const{data:s,error:i}=await supabase.from('photos').select('*').eq('album_id',e).order('created_at',{ascending:true});if(i)throw i;state.currentAlbum={...a,photos:s.map(e=>e.photo_data)};state.otp=t;state.otpExpiry=n;state.shareLink=location.origin+location.pathname+'?album='+e;state.view='gallery';state.loading=false;render()}catch(e){console.error('Upload error:',e);alert('Failed to create album: '+e.message);state.loading=false;render()}}

Â  Â  Â  Â  async function regenOTP(){
Â  Â  Â  Â  Â  Â  if(!state.currentAlbum)return;
Â  Â  Â  Â  Â  Â  state.loading=true;
Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  Â  Â  const e=genOTP();
Â  Â  Â  Â  Â  Â  Â  Â  const t=Date.now()+864e5; 
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const {error:n}=await supabase.from('albums').update({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  otp:e,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  otp_expiry:t
Â  Â  Â  Â  Â  Â  Â  Â  }).eq('id',state.currentAlbum.id);

Â  Â  Â  Â  Â  Â  Â  Â  if(n)throw n;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  state.currentAlbum.otp=e;
Â  Â  Â  Â  Â  Â  Â  Â  state.otp=e;
Â  Â  Â  Â  Â  Â  Â  Â  state.otpExpiry=t;
Â  Â  Â  Â  Â  Â  Â  Â  state.loading=false;
Â  Â  Â  Â  Â  Â  Â  Â  alert('New OTP generated successfully! Access is now valid for the next 24 hours.');
Â  Â  Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  }catch(e){
Â  Â  Â  Â  Â  Â  Â  Â  console.error('OTP error:',e);
Â  Â  Â  Â  Â  Â  Â  Â  alert('Failed to regenerate OTP: '+e.message);
Â  Â  Â  Â  Â  Â  Â  Â  state.loading=false;
Â  Â  Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  async function expireOTP(){
Â  Â  Â  Â  Â  Â  if(!state.currentAlbum)return;if(!confirm('Expire OTP now? This will immediately block all access to your album.'))return;state.loading=true;render();try{const e=Date.now()-1000,{error:t}=await supabase.from('albums').update({otp_expiry:e}).eq('id',state.currentAlbum.id);if(t)throw t;state.currentAlbum.otp_expiry=e;state.otpExpiry=e;state.loading=false;alert('OTP expired successfully! No one can access this album now.');render()}catch(e){console.error('Expire OTP error:',e);alert('Failed to expire OTP: '+e.message);state.loading=false;render()}}
Â  Â  Â  Â  
Â  Â  Â  Â  async function verify(){
Â  Â  Â  Â  Â  Â  if(!verifyFormComplete){alert('Please enter a valid Album ID and a 6-digit OTP.');return}
Â  Â  Â  Â  Â  Â  state.loading=true;render();
Â  Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  Â  Â  const{data:e,error:t}=await supabase.from('albums').select('*').eq('id',state.albumIdToView).single();
Â  Â  Â  Â  Â  Â  Â  Â  if(t||!e){alert('Album not found. Please check your Album ID.');state.loading=false;render();return}
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const isExpired = Date.now() > e.otp_expiry;
Â  Â  Â  Â  Â  Â  Â  Â  if(isExpired){alert('OTP has expired. Please contact the album owner to regenerate it.');state.loading=false;render();return}
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if(e.otp!==state.viewerOtp){alert('Invalid OTP. Please check and try again.');state.loading=false;render();return}
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const{data:n,error:a}=await supabase.from('photos').select('*').eq('album_id',state.albumIdToView).order('created_at',{ascending:true});
Â  Â  Â  Â  Â  Â  Â  Â  if(a)throw a;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  state.currentAlbum={...e,photos:n.map(e=>e.photo_data)};
Â  Â  Â  Â  Â  Â  Â  Â  state.isVerified=true;
Â  Â  Â  Â  Â  Â  Â  Â  state.view='view';
Â  Â  Â  Â  Â  Â  Â  Â  state.loading=false;
Â  Â  Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  Â  Â  // Protection is set up when the viewer opens the lightbox/view
Â  Â  Â  Â  Â  Â  }catch(e){
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Verify error:',e);
Â  Â  Â  Â  Â  Â  Â  Â  alert('Failed to verify album: '+e.message);
Â  Â  Â  Â  Â  Â  Â  Â  state.loading=false;
Â  Â  Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  async function delPhoto(e){
Â  Â  Â  Â  Â  Â  if(!confirm('Are you sure you want to delete this photo?'))return;state.loading=true;render();try{const{data:t,error:n}=await supabase.from('photos').select('id').eq('album_id',state.currentAlbum.id).order('created_at',{ascending:true});if(n)throw n;if(t.length===1){if(confirm('This is the last photo. Delete the entire album?')){await delAlbum();return}else{state.loading=false;render();return}}const a=t[e],{error:o}=await supabase.from('photos').delete().eq('id',a.id);if(o)throw o;state.currentAlbum.photos=state.currentAlbum.photos.filter((t,n)=>n!==e);state.loading=false;alert('Photo deleted successfully');render()}catch(e){console.error('Delete error:',e);alert('Failed to delete photo: '+e.message);state.loading=false;render()}}
Â  Â  Â  Â  
Â  Â  Â  Â  async function delAlbum(){
Â  Â  Â  Â  Â  Â  if(!confirm('Are you sure you want to delete this entire album? This action cannot be undone.'))return;state.loading=true;render();try{const{error:e}=await supabase.from('albums').delete().eq('id',state.currentAlbum.id);if(e)throw e;state.view='home';state.currentAlbum=null;state.loading=false;alert('Album deleted successfully');render()}catch(e){console.error('Delete error:',e);alert('Failed to delete album: '+e.message);state.loading=false;render()}}

Â  Â  Â  Â  function renderHeader() {
Â  Â  Â  Â  Â  Â  // FIX: The 'My Album' button now only appears if the current view is the GALLERY/Management view.
Â  Â  Â  Â  Â  Â  // It will NOT appear if the view is 'view' (viewer path), even if state.currentAlbum is set.
Â  Â  Â  Â  Â  Â  const showMyAlbumButton = state.view === 'gallery';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <header class="bg-gray-800 shadow-lg fixed w-full z-20">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-2xl font-extrabold text-white cursor-pointer" onclick="nav('home')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-purple-400">Amanah</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <nav>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="nav('home')" class="text-sm font-semibold px-4 py-2 rounded-full transition-colors ${state.view === 'home' ? 'bg-purple-600 text-white' : 'text-gray-300 hover:text-white hover:bg-gray-700'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Home
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${showMyAlbumButton ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="nav('gallery')" class="text-sm font-semibold px-4 py-2 rounded-full transition-colors ${state.view === 'gallery' ? 'bg-purple-600 text-white' : 'text-gray-300 hover:text-white hover:bg-gray-700'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  My Album
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </nav>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </header>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function renderFooter(){ 
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <footer class="bg-gray-900 border-t border-gray-700 text-gray-500 mt-16">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="max-w-6xl mx-auto px-4 py-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid md:grid-cols-4 gap-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="md:col-span-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold mb-4 text-purple-400 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  About Amanah
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-400 mb-3 leading-relaxed">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Amanah is a privacy-first photo sharing platform built for sensitive matrimonial use cases. It allows individuals and families to share photos intentionallyâ€”using OTP-based, time-bound access that can be revoked at any moment. Photos cannot be downloaded, forwarded, or reused, and access expires automatically.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold mb-4 text-purple-400">Links</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="space-y-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><a href="#" onclick="nav('home')" class="hover:text-white transition-colors">Home</a></li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><a href="#" onclick="nav('upload')" class="hover:text-white transition-colors">Create Album</a></li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><a href="#" onclick="nav('manage')" class="hover:text-white transition-colors">Manage Album</a></li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><a href="#" onclick="nav('viewer')" class="hover:text-white transition-colors">View Album</a></li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold mb-4 text-purple-400">Contact</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-400 mb-4">Developed by Syed Rashad.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="YOUR_LINKEDIN_PROFILE_URL" target="_blank" class="text-gray-400 hover:text-purple-400 transition-colors flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fab fa-linkedin fa-lg mr-2"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Connect on LinkedIn
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-8 pt-4 border-t border-gray-700 text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-600">&copy; ${new Date().getFullYear()} Amanah. All rights reserved. A Syed Rashad Project.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </footer>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderHomeView() {
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="max-w-6xl mx-auto px-4 pt-24 pb-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center mb-16">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-16 h-16 text-purple-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.044M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-5xl font-extrabold text-white mb-4">Amanah</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-2xl text-purple-300 font-semibold mb-6">Share Marriage Photos Without Losing Control</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-400 max-w-2xl mx-auto leading-relaxed">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Once a marriage photo is shared on WhatsApp or email, it gets forwarded, saved, judged, and stored forever â€” often without consent.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-lg text-gray-300 mt-2 font-medium">Amanah exists to stop that.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-gray-800 rounded-2xl shadow-xl p-8 max-w-3xl mx-auto mb-16 border border-purple-800/50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-3xl font-bold text-white mb-4 text-center">Why Amanah Exists</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-lg text-gray-400 text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Matrimonial photos are meant to be shared with dignity and intention. Existing platforms enable uncontrolled forwarding and permanent storage. Amanah enforces consent, time-bound access, and accountability.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center mb-16">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-3xl font-bold text-white mb-10">The Uncontrolled Sharing Chain</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-3 gap-12 relative max-w-4xl mx-auto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="story-step">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="story-connector right-1/2 md:w-[calc(100%)]"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="story-icon">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-xl font-semibold text-white mb-2">1. Share</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-400">Sender sends photo to one person via WhatsApp/Email.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="story-step story-step-risk">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="story-connector right-1/2 md:w-[calc(100%)]"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="story-icon">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-xl font-semibold text-white mb-2">2. Lost Control</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-400">Receiver saves photo to gallery, then forwards to other groups/family.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="story-step story-step-problem">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="story-icon">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-xl font-semibold text-white mb-2">3. Permanent Loss</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-400">Photo circulates indefinitely, losing its dignity and purpose.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid md:grid-cols-3 gap-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${actionCard(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Upload Photos',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'purple',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Upload marriage photos securely.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>OTP-protected access.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>You stay in control.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Start New Upload',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "nav('upload')"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${actionCard(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Manage Access',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'orange',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Regenerate or expire OTP.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Delete albums anytime.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Revoke access instantly.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Manage Album',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "nav('manage')"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${actionCard(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'View Photos',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'green',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>OTP required.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>No downloads.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Screenshots blocked.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'View Album',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "nav('viewer')"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderUploadView() {
Â  Â  Â  Â  Â  Â  // The rest of the renderUploadView function remains the same...
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="max-w-3xl mx-auto px-4 pt-24 pb-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-3xl font-bold text-white mb-6 text-center">ğŸ” Create Your Secure Album</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-gray-800 p-8 rounded-2xl card-shadow border border-purple-600/50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-semibold text-purple-400 border-b border-gray-700 pb-2">1. Your Details (Uploader)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" placeholder="Your Name (e.g. Syed)" value="${state.uploaderInfo.name}" oninput="updateUploaderName(this)" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-purple-500 focus:border-purple-500" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" placeholder="Your Email (for management access)" value="${state.uploaderInfo.email}" oninput="updateUploaderEmail(this)" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-purple-500 focus:border-purple-500" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-semibold text-purple-400 border-b border-gray-700 pb-2 pt-4">2. Upload Photos (Max 4)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="fileInput" onchange="handleFiles(event)" accept="image/*" multiple class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100" />

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${state.photos.length > 0 ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-4 grid grid-cols-2 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${state.photos.map((photo, index) => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="relative group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${photo}" alt="Preview ${index + 1}" class="w-full h-32 object-cover rounded-lg border border-gray-600">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="state.photos.splice(${index}, 1); checkUploadFormComplete(); render();" class="absolute top-1 right-1 bg-red-600 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : `<p class="text-gray-500 text-center py-4">No photos selected yet.</p>`}

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-semibold text-purple-400 border-b border-gray-700 pb-2 pt-4">3. Terms & Consent</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-start">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="terms-checkbox" onchange="toggleTerms(this)" ${state.termsAccepted ? 'checked' : ''} class="mt-1 w-5 h-5 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="terms-checkbox" class="ml-3 text-sm text-gray-300">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  I confirm that I have the explicit consent of the individuals in these photos to share them under Amanah's secure terms. I understand that access will expire after 24 hours unless manually renewed/revoked. I accept the <a href="#" class="text-purple-400 hover:text-purple-300">Terms & Conditions</a>.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="${uploadFormComplete ? 'upload()' : ''}" class="w-full py-4 text-xl rounded-xl font-bold transition-all mt-6 ${uploadFormComplete ? 'btn-gradient-purple' : 'btn-disabled'}" ${uploadFormComplete ? '' : 'disabled'}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${state.loading ? 'Uploading...' : 'Create Secure Album'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderManageView() {
Â  Â  Â  Â  Â  Â  // The rest of the renderManageView function remains the same...
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="max-w-xl mx-auto px-4 pt-24 pb-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-3xl font-bold text-white mb-6 text-center">âš™ï¸ Manage Your Albums</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-gray-800 p-8 rounded-2xl card-shadow border border-orange-600/50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-400 mb-6 text-center">Enter the email you used to create the album to load it for management.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" placeholder="Your Email Address" value="${state.manageEmail}" oninput="updateManageEmail(this)" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-orange-500 focus:border-orange-500" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="${manageFormComplete ? 'manageAlbum()' : ''}" class="w-full py-3 text-lg rounded-lg font-bold transition-all mt-6 ${manageFormComplete ? 'bg-orange-600 hover:bg-orange-700 text-white' : 'btn-disabled'}" ${manageFormComplete ? '' : 'disabled'}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${state.loading ? 'Loading Album...' : 'Load Album'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderViewerView() {
Â  Â  Â  Â  Â  Â  // The rest of the renderViewerView function remains the same...
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="max-w-xl mx-auto px-4 pt-24 pb-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-3xl font-bold text-white mb-6 text-center">ğŸ”‘ Access Secure Album</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-gray-800 p-8 rounded-2xl card-shadow border border-green-600/50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-400 mb-6 text-center">Enter the Album ID and One-Time Passcode (OTP) provided to you by the sender.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" placeholder="Album ID (e.g. album_xxxxxxxxx)" value="${state.albumIdToView}" oninput="updateAlbumId(this)" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-green-500 focus:border-green-500" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="6-Digit OTP" value="${state.viewerOtp}" oninput="updateViewerOtp(this)" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 text-center text-2xl tracking-widest focus:ring-green-500 focus:border-green-500" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="${verifyFormComplete ? 'verify()' : ''}" class="w-full py-3 text-lg rounded-lg font-bold transition-all mt-6 ${verifyFormComplete ? 'bg-green-600 hover:bg-green-700 text-white' : 'btn-disabled'}" ${verifyFormComplete ? '' : 'disabled'}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${state.loading ? 'Verifying...' : 'View Secured Photos'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderGalleryView() {
Â  Â  Â  Â  Â  Â  if (!state.currentAlbum) return `<div class="pt-24 text-center text-red-400">Album data missing. Please go back to Home or Manage Album.</div>`;
Â  Â  Â  Â  Â  Â  const album = state.currentAlbum;
Â  Â  Â  Â  Â  Â  const isExpired = Date.now() > album.otp_expiry;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // The rest of the renderGalleryView function remains the same...
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="max-w-6xl mx-auto px-4 pt-24 pb-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-3xl font-bold text-white mb-2 text-center">My Secured Album</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-400 text-center mb-6">Album ID: <code class="bg-gray-700 p-1 rounded text-purple-300 text-sm">${album.id}</code></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-gray-800 p-6 rounded-2xl card-shadow border border-orange-600/50 mb-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-5 h-5 mr-2 ${isExpired ? 'text-red-500' : 'text-green-500'}" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Album Access Status
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="md:flex md:justify-between md:items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4 md:mb-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-3xl font-extrabold text-white mb-1 tracking-widest">${state.otp}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm ${isExpired ? 'text-red-400' : 'text-yellow-400'}">Expires in: ${formatTime(state.otpExpiry)}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="copyText()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-white font-semibold flex-shrink-0 transition-colors ${state.loading ? 'btn-disabled' : ''}" ${state.loading ? 'disabled' : ''}>Copy Share Message</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="shareViaWhatsApp()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-white font-semibold flex-shrink-0 transition-colors ${state.loading ? 'btn-disabled' : ''}" ${state.loading ? 'disabled' : ''}>Share via WhatsApp</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-6 pt-4 border-t border-gray-700 flex flex-wrap gap-4 justify-end">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="regenOTP()" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded-lg text-white text-sm transition-colors ${state.loading ? 'btn-disabled' : ''}" ${state.loading ? 'disabled' : ''}>Regenerate OTP (24h)</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="expireOTP()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-white text-sm transition-colors ${state.loading ? 'btn-disabled' : ''}" ${state.loading ? 'disabled' : ''}>Expire OTP Now</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="delAlbum()" class="px-4 py-2 bg-red-800 hover:bg-red-900 rounded-lg text-white text-sm transition-colors ${state.loading ? 'btn-disabled' : ''}" ${state.loading ? 'disabled' : ''}>Delete Album</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-bold text-white mb-4">Photos (${album.photos.length})</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${album.photos.map((photo, index) => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="viewer-thumbnail secure-image-container rounded-lg relative overflow-hidden cursor-pointer group" onclick="openLightbox(${index})">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="secure-photo-${index}" data-photo-data="${photo}" data-watermark="${album.name} [UPLOADER]" class="w-full h-full"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="event.stopPropagation(); delPhoto(${index});" class="absolute bottom-1 right-1 bg-red-600 text-white rounded-lg p-1 text-xs opacity-80 hover:opacity-100 transition-opacity flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderViewView() {
Â  Â  Â  Â  Â  Â  if (!state.currentAlbum) return `<div class="pt-24 text-center text-red-400">Album data missing. Please go back to Home or View Album.</div>`;
Â  Â  Â  Â  Â  Â  const album = state.currentAlbum;
Â  Â  Â  Â  Â  Â  const watermarkText = `${album.name} - Viewer - ID: ${album.id.slice(-4)}`;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // The rest of the renderViewView function remains the same...
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="max-w-6xl mx-auto px-4 pt-24 pb-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-3xl font-bold text-purple-400 mb-2 text-center">Viewing Secured Album</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-400 text-center mb-1">Shared by: ${album.name}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-red-400 text-sm text-center font-semibold">Screenshots and screen recording are prohibited.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-yellow-400 text-sm text-center mb-6">Access expires in: ${formatTime(album.otp_expiry)}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="viewer-content-area">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${album.photos.map((photo, index) => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="viewer-thumbnail secure-image-container rounded-lg relative overflow-hidden cursor-pointer group" onclick="openLightbox(${index})">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="secure-photo-${index}" data-photo-data="${photo}" data-watermark="${watermarkText}" class="w-full h-full"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderLightbox() {
Â  Â  Â  Â  Â  Â  if (state.lightboxIndex === null || !state.currentAlbum) return '';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const album = state.currentAlbum;
Â  Â  Â  Â  Â  Â  const index = state.lightboxIndex;
Â  Â  Â  Â  Â  Â  const photoData = album.photos[index];
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const isUploader = state.view === 'gallery';
Â  Â  Â  Â  Â  Â  const watermarkText = isUploader 
Â  Â  Â  Â  Â  Â  Â  Â  ? `${album.name} [UPLOADER]` 
Â  Â  Â  Â  Â  Â  Â  Â  : `${album.name} - Viewer - ID: ${album.id.slice(-4)}`;

Â  Â  Â  Â  Â  Â  // The rest of the renderLightbox function remains the same...
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div id="lightbox-container" class="fixed inset-0 bg-black bg-opacity-95 z-50 flex items-center justify-center p-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="closeLightbox()" class="absolute top-4 right-4 text-white text-3xl z-50 hover:text-red-500 transition-colors">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="prevPhoto()" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white p-3 rounded-full bg-gray-700/50 hover:bg-gray-700 transition-colors z-40 ${index === 0 ? 'opacity-30 cursor-not-allowed' : ''}" ${index === 0 ? 'disabled' : ''}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="nextPhoto()" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white p-3 rounded-full bg-gray-700/50 hover:bg-gray-700 transition-colors z-40 ${index === album.photos.length - 1 ? 'opacity-30 cursor-not-allowed' : ''}" ${index === album.photos.length - 1 ? 'disabled' : ''}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="max-w-full max-h-full secure-image-container flex items-center justify-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="lightbox-photo" data-photo-data="${photoData}" data-watermark="${watermarkText}" data-is-lightbox="true"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-white bg-gray-700/70 px-4 py-1 rounded-full text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${index + 1} / ${album.photos.length}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  function render() {
Â  Â  Â  Â  Â  Â  const app = document.getElementById('app');
Â  Â  Â  Â  Â  Â  if (!app) return;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  let content = renderHeader();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  switch (state.view) {
Â  Â  Â  Â  Â  Â  Â  Â  case 'upload':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  content += renderUploadView();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'manage':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  content += renderManageView();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'viewer':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  content += renderViewerView();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'gallery':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  content += renderGalleryView();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'view':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  content += renderViewView();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'home':
Â  Â  Â  Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  content += renderHomeView();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  content += renderFooter();
Â  Â  Â  Â  Â  Â  content += renderLightbox();

Â  Â  Â  Â  Â  Â  app.innerHTML = content;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Post-render tasks (Drawing canvases)
Â  Â  Â  Â  Â  Â  const canvases = document.querySelectorAll('canvas[data-photo-data]');
Â  Â  Â  Â  Â  Â  canvases.forEach(canvas => {
Â  Â  Â  Â  Â  Â  Â  Â  const photoData = canvas.getAttribute('data-photo-data');
Â  Â  Â  Â  Â  Â  Â  Â  const watermarkText = canvas.getAttribute('data-watermark');
Â  Â  Â  Â  Â  Â  Â  Â  const isLightbox = canvas.getAttribute('data-is-lightbox') === 'true';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  drawPhotoOnCanvas(canvas.id, photoData, watermarkText, isLightbox);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function init() {
Â  Â  Â  Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  Â  Â  Â  const albumId = urlParams.get('album');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (albumId) {
Â  Â  Â  Â  Â  Â  Â  Â  state.albumIdToView = albumId;
Â  Â  Â  Â  Â  Â  Â  Â  state.view = 'viewer';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  }

Â  Â  Â  Â  // Initial call
Â  Â  Â  Â  init();
Â  Â  </script>
</body>
</html>
