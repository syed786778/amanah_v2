<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Amanah</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { background:#0b1220; color:#e5e7eb }
    .overlay {
      position:fixed; inset:0; background:black;
      display:none; align-items:center; justify-content:center;
      z-index:9999; font-size:24px
    }
    .overlay.active { display:flex }
    canvas { width:100%; height:auto }
  </style>
</head>

<body>
<div id="blocker" class="overlay">âš  Screenshots not allowed</div>
<div id="app"></div>

<script>
/* ================= CONFIG ================= */
const supabase = window.supabase.createClient(
  'https://imiljivxosyrcosznklh.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltaWxqaXZ4b3N5cmNvc3pua2xoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMTIwOTcsImV4cCI6MjA3OTY4ODA5N30.TOgeuC3-RdG2ywIxDz2NWRhLHI4gxTkG4pilaZBqhso'
);

/* ================= STATE ================= */
const state = {
  view: 'home',           // home | upload | viewer | gallery
  mode: null,             // owner | viewer
  uploader: { name:'', email:'' },
  photos: [],
  album: null,
  otp: '',
  otpExpiry: 0,
  albumId: '',
  viewerOtp: '',
  shareLink: '',
  loading: false,
  screenshotCount: 0
};

/* ================= HELPERS ================= */
const genId = () => 'alb_' + Math.random().toString(36).slice(2,9);
const genOtp = () => Math.floor(100000+Math.random()*900000).toString();
const nav = v => { state.view=v; render(); };

function blockViewer() {
  if (state.mode !== 'viewer') return;
  state.screenshotCount++;
  if (state.screenshotCount >= 2) {
    document.getElementById('blocker').classList.add('active');
    setTimeout(() => location.reload(), 1500);
  }
}

/* ================= UPLOAD ================= */
async function uploadAlbum() {
  if (!state.uploader.name || !state.uploader.email || !state.photos.length) {
    alert('Missing info'); return;
  }

  const id = genId();
  const otp = genOtp();
  const expiry = Date.now() + 24*60*60*1000;

  await supabase.from('albums').insert({
    id,
    name: state.uploader.name,
    email: state.uploader.email.toLowerCase(),
    otp,
    otp_expiry: expiry
  });

  await supabase.from('photos').insert(
    state.photos.map(p => ({ album_id:id, photo_data:p }))
  );

  state.album = { id, name: state.uploader.name, photos: state.photos };
  state.otp = otp;
  state.otpExpiry = expiry;
  state.shareLink = location.origin + location.pathname + '?album=' + id;
  state.mode = 'owner';
  state.view = 'gallery';
  render();
}

/* ================= VERIFY ================= */
async function verifyAlbum() {
  const { data:album } = await supabase
    .from('albums').select('*')
    .eq('id', state.albumId).single();

  if (!album || album.otp !== state.viewerOtp || Date.now() > album.otp_expiry) {
    alert('Invalid OTP'); return;
  }

  const { data:photos } = await supabase
    .from('photos').select('*')
    .eq('album_id', album.id)
    .order('created_at');

  state.album = { ...album, photos: photos.map(p=>p.photo_data) };
  state.mode = 'viewer';
  state.view = 'gallery';
  render();
}

/* ================= RENDER ================= */
function render() {
  const app = document.getElementById('app');
  app.innerHTML = `
    ${state.view === 'home' ? `
      <div class="h-screen flex flex-col items-center justify-center">
        <h1 class="text-5xl font-bold mb-8 text-purple-400">Amanah</h1>
        <div>
          <button onclick="nav('upload')" class="bg-purple-600 px-6 py-3 rounded mr-4">Create Album</button>
          <button onclick="nav('viewer')" class="bg-gray-700 px-6 py-3 rounded">View Album</button>
        </div>
      </div>
    ` : ''}

    ${state.view === 'upload' ? `
      <div class="max-w-xl mx-auto p-8">
        <h2 class="text-2xl mb-4">Create Album</h2>
        <input class="w-full mb-3 p-2 bg-gray-800" placeholder="Name"
          oninput="state.uploader.name=this.value">
        <input class="w-full mb-3 p-2 bg-gray-800" placeholder="Email"
          oninput="state.uploader.email=this.value">
        <input type="file" multiple accept="image/*" class="mb-4"
          onchange="
            [...this.files].forEach(f=>{
              const r=new FileReader();
              r.onload=e=>state.photos.push(e.target.result);
              r.readAsDataURL(f);
            });
          ">
        <button onclick="uploadAlbum()" class="bg-purple-600 px-6 py-3 rounded">Create</button>
        <button onclick="nav('home')" class="ml-4 text-gray-400">Cancel</button>
      </div>
    ` : ''}

    ${state.view === 'viewer' ? `
      <div class="max-w-md mx-auto p-8">
        <h2 class="text-2xl mb-4">View Album</h2>
        <input class="w-full mb-3 p-2 bg-gray-800" placeholder="Album ID"
          oninput="state.albumId=this.value">
        <input class="w-full mb-4 p-2 bg-gray-800" placeholder="OTP"
          oninput="state.viewerOtp=this.value">
        <button onclick="verifyAlbum()" class="bg-purple-600 px-6 py-3 rounded">View</button>
        <button onclick="nav('home')" class="ml-4 text-gray-400">Cancel</button>
      </div>
    ` : ''}

    ${state.view === 'gallery' && state.album ? `
      <div class="p-8">
        <h2 class="text-2xl mb-4">${state.album.name}'s Album</h2>

        ${state.mode === 'owner' ? `
          <div class="bg-gray-800 p-4 rounded mb-6">
            <p><strong>OTP:</strong> ${state.otp}</p>
            <p class="break-all text-sm">${state.shareLink}</p>
          </div>
        ` : ''}

        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
          ${state.album.photos.map((p,i)=>`
            <canvas id="img${i}"></canvas>
          `).join('')}
        </div>
      </div>
    ` : ''}
  `;

  if (state.view === 'gallery') {
    document.oncontextmenu = e => { e.preventDefault(); blockViewer(); };
    state.album.photos.forEach((src,i)=>{
      const img=new Image();
      img.onload=()=>{
        const c=document.getElementById('img'+i);
        c.width=img.width; c.height=img.height;
        c.getContext('2d').drawImage(img,0,0);
      };
      img.src=src;
    });
  }
}

/* ================= INIT ================= */
const q = new URLSearchParams(location.search);
if (q.get('album')) {
  state.albumId = q.get('album');
  nav('viewer');
} else {
  render();
}
</script>
</body>
</html>
